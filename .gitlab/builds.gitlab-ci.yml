##############################################################
# Copyright 2023 Lawrence Livermore National Security, LLC
# (c.f. AUTHORS, NOTICE.LLNS, COPYING)
#
# This file is part of the Flux resource manager framework.
# For details, see https://github.com/flux-framework.
#
# SPDX-License-Identifier: LGPL-3.0
##############################################################

include:
  - local: '.gitlab/machines.gitlab-ci.yml'

.build-core:
    extends: .lc-variables
    script:
        - test -n ${CI_PIPELINE_ID}
        - export FTC_DIRECTORY=$(pwd)
        - mkdir /usr/WS1/${USER}/cibuilds/${CI_PIPELINE_ID}_${LCSCHEDCLUSTER}
        - export CI_DIRECTORY=/usr/WS1/${USER}/cibuilds/${CI_PIPELINE_ID}_${LCSCHEDCLUSTER}
        - cd ${CI_DIRECTORY}
        - git clone https://github.com/flux-framework/flux-core
        - cd flux-core
        - ./autogen.sh
        - mkdir build
        - cd build
        - mkdir install
        - ../configure --prefix=$(pwd)/install
        - make -j $(nproc)
        ## need to install to get pkgconfig files
        - export CORE_BUILD_DIR=$(pwd)
        - export CORE_INSTALL_PREFIX=$(pwd)/install
        - cd $FTC_DIRECTORY
        - echo "CI_DIRECTORY=${CI_DIRECTORY}" >> build.env
        - echo "CORE_BUILD_DIR=${CORE_BUILD_DIR}" >> build.env
        - echo "CORE_INSTALL_PREFIX=${CORE_INSTALL_PREFIX}" >> build.env
    ## Save the exported directory names so later jobs can use the binaries that have already been built
    ## send these dirnames to tests as a .env file
    artifacts:
        reports:
            dotenv:
                - build.env

.test-pmix:
    extends: .lc-variables
    variables:
        debug: t
        FLUX_TESTS_LOGFILE: t
    script:
        - export PKG_CONFIG_PATH=${CORE_INSTALL_PREFIX}/lib/pkgconfig:$(pkg-config --variable pc_path pkg-config)
        - module load openmpi
        - export PKG_CONFIG_PATH=$(dirname $(which mpicc))/../lib/pkgconfig:${PKG_CONFIG_PATH} 
        - cd ${CI_DIRECTORY}
        - git clone https://github.com/flux-framework/flux-pmix
        - cd flux-pmix
        - ./autogen.sh
        - ./configure --prefix=${CORE_INSTALL_PREFIX}
        - make -j $(nproc) check
        - make -j $(nproc) install
 